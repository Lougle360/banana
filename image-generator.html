<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIMart å›¾ç‰‡ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FFE135 0%, #F9A826 100%);
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #FFE135;
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #FFE135 0%, #F9A826 100%);
            color: #333;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: block;
            margin: 30px auto;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 225, 53, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FFE135;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #FFE135 0%, #F9A826 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .result {
            margin-top: 40px;
            display: none;
        }

        .result.active {
            display: block;
        }

        .result h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-item img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-item img:hover {
            transform: scale(1.02);
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .error.active {
            display: block;
        }

        .time-info {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }

        .example-prompts {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .example-prompt {
            padding: 8px 15px;
            background: #f5f5f5;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .example-prompt:hover {
            background: #f9a826;
            color: white;
        }

        .reference-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .reference-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .reference-input input {
            flex: 1;
        }

        .reference-input button {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .reference-input button:hover {
            background: #5a6268;
        }

        .reference-list {
            margin-top: 10px;
        }

        .reference-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .reference-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }

        .reference-item button {
            margin-left: auto;
            padding: 5px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .reference-item button:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ APIMart å›¾ç‰‡ç”Ÿæˆå™¨</h1>
            <p>ä½¿ç”¨ AI æŠ€æœ¯ç”Ÿæˆç²¾ç¾å›¾ç‰‡</p>
        </div>

        <div class="main-content">
            <form id="generateForm">
                <div class="form-group">
                    <label for="prompt">å›¾ç‰‡æè¿° *</label>
                    <textarea id="prompt" placeholder="è¯·æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡ï¼Œä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„çŒ«å’ªåœ¨èŠ±å›­é‡Œç©è€..." required></textarea>
                    <div class="example-prompts">
                        <span class="example-prompt" onclick="setPrompt('ä¸€åªç©¿ç€å®‡èˆªæœçš„é¦™è•‰åœ¨ç«æ˜Ÿä¸Šæ’ç€æ——å¸œ')">ğŸŒ ç«æ˜Ÿé¦™è•‰</span>
                        <span class="example-prompt" onclick="setPrompt('æ¢µé«˜é£æ ¼çš„å‘æ—¥è‘µé¦™è•‰ç”°')">ğŸ¨ è‰ºæœ¯é¦™è•‰</span>
                        <span class="example-prompt" onclick="setPrompt('é¦™è•‰å½¢çŠ¶çš„å®‡å®™é£èˆ¹ç©¿è¶Šæ—¶ç©ºéš§é“')">ğŸš€ ç§‘å¹»é¦™è•‰</span>
                        <span class="example-prompt" onclick="setPrompt('å¯çˆ±çš„é¦™è•‰å®å®åœ¨å½©è™¹ä¸Šæ»‘æ»‘æ¢¯')">ğŸŒˆ æ¢¦å¹»é¦™è•‰</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="model">æ¨¡å‹é€‰æ‹©</label>
                    <select id="model">
                        <option value="gpt-4o-image">GPT-4o Image</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="size">å›¾ç‰‡å°ºå¯¸</label>
                    <select id="size">
                        <option value="1:1">æ­£æ–¹å½¢ (1:1)</option>
                        <option value="2:3">ç«–ç‰ˆ (2:3)</option>
                        <option value="3:2">æ¨ªç‰ˆ (3:2)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="n">ç”Ÿæˆæ•°é‡</label>
                    <select id="n">
                        <option value="1">1å¼ </option>
                        <option value="2">2å¼ </option>
                        <option value="4">4å¼ </option>
                    </select>
                </div>

                <div class="reference-section">
                    <label>å‚è€ƒå›¾ç‰‡ (å¯é€‰)</label>
                    <div class="reference-input">
                        <input type="text" id="referenceUrl" placeholder="è¾“å…¥å›¾ç‰‡URL">
                        <button type="button" onclick="addReference()">æ·»åŠ </button>
                    </div>
                    <div class="reference-list" id="referenceList"></div>
                </div>

                <button type="submit" class="btn" id="generateBtn">
                    ğŸš€ ç”Ÿæˆå›¾ç‰‡
                </button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h3>æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-info" id="timeInfo">é¢„è®¡æ—¶é—´ï¼šè®¡ç®—ä¸­...</div>
            </div>

            <div class="error" id="error"></div>

            <div class="result" id="result">
                <h2>ğŸ‰ ç”Ÿæˆå®Œæˆï¼</h2>
                <div class="image-grid" id="imageGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // API é…ç½®
        const API_BASE = 'https://api.apimart.ai';
        const API_KEY = 'sk-XnOPrxWN5Pz3b1qFcIh7tUwhuFwq6wVNDENS15s4eJricRPK';
        const TIMEOUT = 15 * 60 * 1000; // 15åˆ†é’Ÿè¶…æ—¶

        // å‚è€ƒå›¾ç‰‡åˆ—è¡¨
        let referenceImages = [];

        // è®¾ç½®ç¤ºä¾‹æç¤ºè¯
        function setPrompt(text) {
            document.getElementById('prompt').value = text;
        }

        // æ·»åŠ å‚è€ƒå›¾ç‰‡
        function addReference() {
            const url = document.getElementById('referenceUrl').value.trim();
            if (!url) return;

            if (!isValidUrl(url)) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URL');
                return;
            }

            referenceImages.push(url);
            updateReferenceList();
            document.getElementById('referenceUrl').value = '';
        }

        // æ›´æ–°å‚è€ƒå›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
        function updateReferenceList() {
            const list = document.getElementById('referenceList');
            list.innerHTML = referenceImages.map((url, index) => `
                <div class="reference-item">
                    <img src="${url}" alt="å‚è€ƒå›¾ ${index + 1}" onerror="this.style.display='none'">
                    <span>${url}</span>
                    <button type="button" onclick="removeReference(${index})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        // åˆ é™¤å‚è€ƒå›¾ç‰‡
        function removeReference(index) {
            referenceImages.splice(index, 1);
            updateReferenceList();
        }

        // URL éªŒè¯
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('generateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const prompt = document.getElementById('prompt').value.trim();
            const model = document.getElementById('model').value;
            const size = document.getElementById('size').value;
            const n = parseInt(document.getElementById('n').value);

            if (!prompt) {
                showError('è¯·è¾“å…¥å›¾ç‰‡æè¿°');
                return;
            }

            await generateImage(prompt, model, size, n, referenceImages);
        });

        // ç”Ÿæˆå›¾ç‰‡
        async function generateImage(prompt, model, size, n, imageUrls) {
            hideError();
            hideResult();
            showLoading();

            try {
                // åˆ›å»ºä»»åŠ¡
                const createResponse = await fetch(`${API_BASE}/v1/images/generations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        prompt: prompt,
                        size: size,
                        n: n,
                        image_urls: imageUrls.length > 0 ? imageUrls : undefined
                    })
                });

                const createData = await createResponse.json();

                if (createData.code !== 200 || !createData.data || !createData.data[0]) {
                    throw new Error(createData.message || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                }

                const taskId = createData.data[0].task_id;

                // è½®è¯¢æŸ¥è¯¢ç»“æœ
                await pollTaskResult(taskId);

            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                showError(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
                hideLoading();
            }
        }

        // è½®è¯¢æŸ¥è¯¢ä»»åŠ¡ç»“æœ
        async function pollTaskResult(taskId) {
            const startTime = Date.now();
            const checkInterval = 3000; // 3ç§’æŸ¥è¯¢ä¸€æ¬¡

            const checkStatus = async () => {
                // æ£€æŸ¥è¶…æ—¶
                if (Date.now() - startTime > TIMEOUT) {
                    throw new Error('ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•');
                }

                try {
                    const response = await fetch(`${API_BASE}/v1/tasks/${taskId}`, {
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`
                        }
                    });

                    const data = await response.json();

                    if (data.code !== 200) {
                        throw new Error(data.message || 'æŸ¥è¯¢å¤±è´¥');
                    }

                    const task = data.data;
                    updateProgress(task.progress || 0);

                    if (task.status === 'completed') {
                        hideLoading();
                        showResult(task.result.images);
                        return;
                    } else if (task.status === 'failed') {
                        throw new Error('ä»»åŠ¡å¤±è´¥');
                    } else if (task.status === 'submitted' || task.status === 'processing' || task.status === 'pending') {
                        // ç»§ç»­è½®è¯¢
                        setTimeout(checkStatus, checkInterval);

                        // æ›´æ–°é¢„è®¡æ—¶é—´
                        if (task.estimated_time) {
                            const minutes = Math.ceil(task.estimated_time / 60);
                            document.getElementById('timeInfo').textContent = `é¢„è®¡æ—¶é—´ï¼š${minutes}åˆ†é’Ÿ`;
                        }
                    } else {
                        throw new Error(`æœªçŸ¥çŠ¶æ€: ${task.status}`);
                    }

                } catch (error) {
                    throw error;
                }
            };

            await checkStatus();
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(progress) {
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = 'ç”Ÿæˆä¸­...';
            updateProgress(0);
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').textContent = 'ğŸš€ ç”Ÿæˆå›¾ç‰‡';
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(images) {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = images.map(img =>
                img.url.map(url => `
                    <div class="image-item">
                        <img src="${url}" alt="ç”Ÿæˆçš„å›¾ç‰‡" onclick="window.open('${url}', '_blank')">
                    </div>
                `).join('')
            ).join('');

            document.getElementById('result').classList.add('active');
        }

        // éšè—ç»“æœ
        function hideResult() {
            document.getElementById('result').classList.remove('active');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.getElementById('error').classList.remove('active');
        }
    </script>
</body>
</html>